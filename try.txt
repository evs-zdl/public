$ErrorActionPreference = "Stop"

$UserUpn  = "user@domain.com"
$RoleName = "AI Administrator"

# Resolve user object id
$UserId = (az ad user show --id $UserUpn --query id -o tsv).Trim()
if (-not $UserId) { throw "User not found: $UserUpn" }

# Resolve active directory role id
$RoleId = (az rest --method GET `
  --url "https://graph.microsoft.com/v1.0/directoryRoles" `
  --query "value[?displayName=='$RoleName'].id" -o tsv).Trim()
if (-not $RoleId) { throw "Role not found in /directoryRoles: $RoleName (may be inactive in this tenant)" }

# Build JSON body as a literal string (most robust in PowerShell)
$Body = @"
{"@odata.id":"https://graph.microsoft.com/v1.0/directoryObjects/$UserId"}
"@.Trim()

# Add user to role via $ref
az rest --method POST `
  --url "https://graph.microsoft.com/v1.0/directoryRoles/$RoleId/members/`$ref" `
  --headers "{'Content-Type':'application/json'}" `
  --body $Body | Out-Null

Write-Host "Added $UserUpn to role '$RoleName'."

# Verify (names)
az rest --method GET `
  --url "https://graph.microsoft.com/v1.0/directoryRoles/$RoleId/members?`$select=displayName,userPrincipalName,id" `
  --query "value[].{displayName:displayName, userPrincipalName:userPrincipalName, id:id}" `
  -o table
