$ErrorActionPreference = "Stop"

# ===== CONFIG =====
$UserUpn   = "user@domain.com"
$GroupName = "My Security Group"
# ==================

# Resolve user object ID
$UserId = (az ad user show --id $UserUpn --query id -o tsv).Trim()
if (-not $UserId) { throw "User not found: $UserUpn" }

# Resolve group object ID
$GroupId = (az ad group list `
    --filter "displayName eq '$GroupName'" `
    --query "[0].id" -o tsv).Trim()

if (-not $GroupId) { throw "Group not found: $GroupName" }

# Check if user already member
$already = az rest --method GET `
  --url "https://graph.microsoft.com/v1.0/groups/$GroupId/members?`$select=id" `
  --query "value[?id=='$UserId'] | length(@)" `
  -o tsv

if ([int]$already -gt 0) {
    Write-Host "User '$UserUpn' is already in group '$GroupName'"
    exit 0
}

# Build JSON body
$Body = '{"@odata.id":"https://graph.microsoft.com/v1.0/directoryObjects/' + $UserId + '"}'

# Add user to group
az rest --method POST `
  --url "https://graph.microsoft.com/v1.0/groups/$GroupId/members/`$ref" `
  --headers "Content-Type=application/json" `
  --body $Body | Out-Null

Write-Host "Added '$UserUpn' to group '$GroupName'"

# Verify membership
az rest --method GET `
  --url "https://graph.microsoft.com/v1.0/groups/$GroupId/members?`$select=displayName,userPrincipalName,id" `
  --query "value[].{displayName:displayName, userPrincipalName:userPrincipalName, id:id}" `
  -o table


# group type
$GroupId = (az ad group list --filter "displayName eq 'SEC-PIM-Global Administrator Role'" --query "[0].id" -o tsv).Trim()
az rest --method GET --url "https://graph.microsoft.com/v1.0/groups/$GroupId?`$select=id,displayName,isAssignableToRole" -o json



# login activity
$UserUpn = "user@domain.com"

# Get user object ID
$UserId = (az ad user show --id $UserUpn --query id -o tsv).Trim()

# Query last sign-in info
az rest --method GET `
  --url "https://graph.microsoft.com/v1.0/users/$UserId?`$select=displayName,userPrincipalName,signInActivity" `
  --query "{
    User:userPrincipalName,
    LastInteractive:signInActivity.lastSignInDateTime,
    LastNonInteractive:signInActivity.lastNonInteractiveSignInDateTime,
    LastSuccessful:signInActivity.lastSuccessfulSignInDateTime
  }" `
  -o table
